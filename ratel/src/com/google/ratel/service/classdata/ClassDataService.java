package com.google.ratel.service.classdata;

import com.google.ratel.*;
import java.util.*;
import java.util.Map;
import javax.servlet.ServletContext;
import com.google.ratel.util.ClassPathScanner;
import com.google.ratel.util.RatelUtils;
import com.google.ratel.core.RatelService;
import com.google.ratel.deps.io.*;
import com.google.ratel.service.json.*;
import com.google.ratel.service.log.*;
import java.io.*;
import java.util.logging.*;

public class ClassDataService {

    protected Map<String, ClassData> serviceByPathMap;

    protected ServletContext servletContext;

    protected RatelConfig ratelConfig;

    protected List<String> packageNames;

    public ClassDataService(RatelConfig ratelConfig, List<String> packageNames) {
        this.packageNames = packageNames;
        this.ratelConfig = ratelConfig;
        this.servletContext = ratelConfig.getServletContext();
    }

    public Map<String, ClassData> getAllServiceClassData() {
        // TODO add the data to the runtime
        if (serviceByPathMap == null) {
            Map tempClassDataMap = new HashMap<String, ClassData>();

            Set<Class> classes = new HashSet<Class>();
            LogService logService = ratelConfig.getLogService();

            // Retrieve data from file that was generated by ANT. This is for environments where WAR is not unpacked
            String classDataPath = "/META-INF/resources/classdata.json";
            InputStream stream = servletContext.getResourceAsStream(classDataPath);

            if (stream == null) {
                logService.info("Ratel services will discovered by scanning the classpath.");
                ClassPathScanner scanner = new ClassPathScanner(servletContext, RatelService.class, packageNames);
                classes = scanner.scan();

            } else {
                logService.info("Ratel services will be discovered through '" + classDataPath + "'.");

                try {
                    String json = IOUtils.toString(stream);
                    JsonService jsonService = ratelConfig.getJsonService();
                    Set<String> classSet = jsonService.fromJson(json, Set.class);
                    for (String name : classSet) {
                        Class cls = RatelUtils.classForName(name, logService);
                        classes.add(cls);
                    }

                } catch (IOException ex) {
                    logService.error("Error occurred while reading '" + classDataPath + "'.", ex);

                } finally {
                    IOUtils.closeQuietly(stream);
                }
            }
            
            if (logService.isDebugEnabled()) {
                    logService.debug("The following Ratel services were discovered:");
                }

            for (Class serviceClass : classes) {

                ClassData classData = RatelUtils.createClassData(serviceClass, packageNames);

                RatelUtils.populateMethods(classData);

                if (logService.isDebugEnabled()) {
                    String msg = "   " + classData.getServicePath() + " -> " + serviceClass.getName();
                    logService.debug(msg);
                }

                tempClassDataMap.put(classData.getServicePath(), classData);
            }

            serviceByPathMap = tempClassDataMap;
        }
        return serviceByPathMap;
    }
}
